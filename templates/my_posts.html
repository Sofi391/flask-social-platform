<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <title>{{ user.name }}'s Profile</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/user_profile.css') }}">
        {% include "header.html" %}
    </head>
    <body>
        <!-- Profile Header -->
        <header class="profile-header">
            <div class="container">
                <div class="profile-container">
                    <!-- Profile Info -->
                    <div class="profile-main">
                        <div class="profile-avatar">
                            <img src="{{ user.email | gravatar }}" alt="{{ user.name }}" class="avatar-img">
                            {% if current_user.id == user.id %}
                            <div class="online-status"></div>
                            {% endif %}
                        </div>
                        <div class="profile-info">
                            <h1 class="profile-name">{{ user.name }}</h1>
                            <p class="profile-email">{{ user.email }}</p>
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <span class="stat-number">{{ posts|length }}</span>
                                    <span class="stat-label">Posts</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">{{ total_likes }}</span>
                                    <span class="stat-label">Likes</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    {% if current_user.id == user.id %}
                    <div class="profile-actions">
                        <a href="{{ url_for('new_post') }}" class="btn-primary">
                            <i class="bi bi-plus-circle"></i>
                            New Post
                        </a>
                        <button class="btn-secondary" onclick="toggleEditMode()">
                            <i class="bi bi-pencil"></i>
                            Edit Profile
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="profile-content">
            <div class="container">
                <!-- Posts Section -->
                <section class="posts-section">
                    <div class="section-header">
                        <h2>Posts</h2>
                    </div>

                    {% if not posts %}
                    <!-- Empty State -->
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="bi bi-file-earmark-text"></i>
                        </div>
                        <h3>No Posts Yet</h3>
                        <p>When {{ user.name }} creates posts, they'll appear here.</p>
                        {% if current_user.id == user.id %}
                        <a href="{{ url_for('new_post') }}" class="btn-primary">
                            <i class="bi bi-plus-circle"></i>
                            Create Your First Post
                        </a>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- Posts Grid -->
                    <div class="posts-grid" id="posts-container">
                        {% for post in posts %}
                        <article class="post-card" data-post-id="{{ post.id }}">
                            <!-- Post Header -->
                            <div class="post-header">
                                <span class="post-date" data-date="{{ post.date }}">
                                    {{ post.date }}
                                </span>

                                {% if current_user.is_admin or current_user.id == post.author.id %}
                                <div class="post-actions">
                                    <div class="dropdown">
                                        <button class="action-btn" type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item" href="{{ url_for('edit_post', id=post.id) }}">
                                                    <i class="bi bi-pencil"></i>Edit
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item text-danger delete-post"
                                                   data-url="{{ url_for('delete_post', id=post.id) }}">
                                                    <i class="bi bi-trash"></i>Delete
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Post Content -->
                            <a href="{{ url_for('post_page', id=post.id) }}" class="post-content-link">
                                <h3 class="post-title">{{ post.title }}</h3>
                                <p class="post-subtitle">{{ post.subtitle }}</p>
                                <div class="post-preview">
                                    {{ post.body|striptags|truncate(200) }}
                                </div>
                            </a>

                            <!-- Post Footer -->
                            <div class="post-footer">
                                <div class="post-stats">
                                    <form action="{{ url_for('post_like', post_id=post.id) }}" method="POST"
                                          class="like-form" data-post-id="{{ post.id }}">
                                        <button type="submit" class="like-btn {% if post in current_user.likes|map(attribute='post') %}liked{% endif %}">
                                            <i class="bi bi-heart-fill"></i>
                                            <span class="like-count">{{ post.likes|length }}</span>
                                        </button>
                                    </form>
                                    <span class="view-count">
                                        <i class="bi bi-eye"></i>
                                        {{ post.views or 0 }}
                                    </span>
                                </div>
                                <a href="{{ url_for('post_page', id=post.id) }}" class="read-more">
                                    Read More <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </article>
                        {% endfor %}
                    </div>
                    {% endif %}
                </section>
            </div>
        </main>

        {% include "footer.html" %}

        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Inline JavaScript -->
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Format dates on client side
            function formatDate(dateString) {
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                } catch (e) {
                    return dateString; // Return original if parsing fails
                }
            }

            // Format all post dates
            document.querySelectorAll('.post-date').forEach(element => {
                const originalDate = element.getAttribute('data-date');
                if (originalDate) {
                    element.textContent = formatDate(originalDate);
                }
            });

            // Like functionality
            document.querySelectorAll('.like-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const postId = this.dataset.postId;
                    const likeBtn = this.querySelector('.like-btn');
                    const likeCount = this.querySelector('.like-count');

                    fetch(this.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(new FormData(this))
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.likes_count !== undefined) {
                            likeCount.textContent = data.likes_count;
                            if (data.liked) {
                                likeBtn.classList.add('liked');
                            } else {
                                likeBtn.classList.remove('liked');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Like error:', error);
                        this.submit();
                    });
                });
            });

            // Delete post confirmation
            document.querySelectorAll('.delete-post').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                        window.location.href = this.dataset.url;
                    }
                });
            });

            // Post card animations
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.post-card').forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'all 0.6s ease';
                observer.observe(card);
            });
        });

        function toggleEditMode() {
            // Edit profile functionality
            alert('Edit profile feature coming soon!');
        }
        </script>
    </body>
</html>