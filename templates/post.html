<!DOCTYPE html>
<html lang="en">
{% include "header.html" %}
{% from "bootstrap5/form.html" import render_form %}
<body>

<!-- Page Header -->
<header class="masthead" style="background-image: url('{{ post.img_url }}')">
    <div class="container position-relative px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                <div class="post-heading">
                    <h1>{{ post.title }}</h1>
                    <h2 class="subheading">{{ post.subtitle }}</h2>
                    <span class="meta">
                        Posted by <a href="#!">{{ post.author.name }}</a> on {{ post.date }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article class="mb-4">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                <p>{{ post.body | safe }}</p>
                <a href="#!"><img class="img-fluid" src="{{ post.img_url }}" alt="..." /></a>

            {% if current_user.is_admin %}
            <div class="d-flex justify-content-end mb-4">
                <a class="admin-edit-btn" href="{{ url_for('edit_post', id=post.id) }}">
                    <span class="admin-badge">ADMIN</span>
                    Edit Post <i class="bi bi-pencil ms-1" style="font-size: 0.8rem;"></i>
                </a>
            </div>
            {% endif %}

                <!-- Toggle Comment Section -->
                <div class="comment-toggle-wrapper">
                    <button class="btn btn-comment-toggle" id="toggleCommentSection">
                        <i class="bi bi-chat-dots"></i> Comments
                        <span class="comment-count-badge">{{ post.comments|length }}</span>
                    </button>
                </div>

                <!-- Comment Section -->
                <div id="commentSection" class="mt-3" style="display: none;">
                    <!-- Enhanced Comment Form -->
                    <div class="comment-form-container">
                        <form method="POST" class="comment-form">
                            {{ form.hidden_tag() }}

                            <div class="form-group">
                                {{ form.comment.label(class="form-label") }}
                                {{ form.comment(class="form-control comment-input-field", placeholder="Add a comment here...", rows="3") }}
                                <div class="char-counter" id="charCounter">0/500</div>
                            </div>

                            <div class="d-flex justify-content-end">
                                {{ form.submit(class="comment-submit-btn") }}
                            </div>
                        </form>
                    </div>

                    <!-- Comments list -->
                    <div class="custom-comments-list mb-3">
                        {% for comment in post.comments|sort(attribute='date', reverse=True) %}
                        <div class="custom-comment-card" data-comment-id="{{ comment.id }}">
                            <div class="custom-comment-header">
                                <img src="{{ comment.author.email | gravatar }}" class="custom-comment-avatar" alt="avatar">
                                <div class="custom-comment-content">
                                    <strong>{{ comment.author.name }}</strong>

                                    <!-- Check if this comment is being edited -->
                                    {% if edited == comment.id and current_user.id == comment.author.id %}
                                    <!-- Edit Comment Form -->
                                    <form method="POST" action="{{ url_for('edit_comment', comment_id=comment.id) }}" class="edit-comment-form">
                                        <textarea name="comment" class="form-control mb-2" rows="3" required>{{ comment.text }}</textarea>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-sm btn-success">
                                                <i class="bi bi-check-lg"></i> Save Changes
                                            </button>
                                            <a href="{{ url_for('post_page', id=post.id) }}" class="btn btn-sm btn-secondary">
                                                <i class="bi bi-x-lg"></i> Cancel
                                            </a>
                                        </div>
                                    </form>
                                    {% else %}
                                    <!-- Normal Comment Display -->
                                    <p class="custom-comment-text">{{ comment.text | safe }}</p>
                                    <small class="text-muted">{{ comment.date.strftime('%b %d, %Y %H:%M') }}</small>
                                    {% if comment.edited %}
                                    <small class="text-muted"> (Edited)</small>
                                    {% endif %}
                                    {% endif %}

                                    <!-- Like button -->
                                    <form action="{{ url_for('like_comment', comment_id=comment.id) }}" method="POST"
                                          class="custom-like-form" data-comment-id="{{ comment.id }}">
                                        <button type="submit" class="custom-like-btn {% if comment in current_user.likes|map(attribute='comment') %}liked{% endif %}"
                                                data-comment-id="{{ comment.id }}">
                                            <i class="bi bi-heart-fill"></i>
                                            <span class="custom-like-count">{{ comment.likes|length }}</span>
                                        </button>
                                    </form>
                                </div>

                                <!-- Dropdown menu -->
                                <div class="dropdown comment-dropdown">
                                    <button class="btn btn-sm" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#"><i class="bi bi-reply"></i> Reply</a></li>
                                        {% if current_user.id == comment.author.id %}
                                        <li><a class="dropdown-item" href="{{ url_for('edit_comment', comment_id=comment.id) }}"><i class="bi bi-pencil"></i> Edit</a></li>
                                        {% endif %}
                                        {% if current_user.is_admin or current_user.id == comment.author.id or current_user.id == comment.post.author.id %}
                                        <li><a class="dropdown-item text-danger" href="{{ url_for('delete_comment', comment_id=comment.id) }}"><i class="bi bi-trash"></i> Delete</a></li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-chat-square-text display-4 text-muted mb-3"></i>
                            <p class="mb-0 text-muted">No comments yet. Be the first to comment!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>
    </div>
</article>

{% include "footer.html" %}

<!-- Bootstrap core JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Post-specific JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const toggleBtn = document.getElementById("toggleCommentSection");
    const commentSection = document.getElementById("commentSection");

    // Toggle comment section with animation
    toggleBtn.addEventListener("click", () => {
        if (commentSection.style.display === "none" || !commentSection.style.display) {
            commentSection.style.display = "block";
            setTimeout(() => {
                commentSection.style.opacity = "1";
                commentSection.style.transform = "translateY(0)";
            }, 10);
        } else {
            commentSection.style.opacity = "0";
            commentSection.style.transform = "translateY(20px)";
            setTimeout(() => {
                commentSection.style.display = "none";
            }, 300);
        }
    });

    // Initialize comment section with transition properties
    commentSection.style.transition = "all 0.3s ease-out";
    commentSection.style.opacity = "0";
    commentSection.style.transform = "translateY(20px)";

    // Character counter for comment form
    const commentInput = document.querySelector('.comment-input-field');
    const charCounter = document.getElementById('charCounter');

    if (commentInput && charCounter) {
        commentInput.addEventListener('input', function() {
            const length = this.value.length;
            charCounter.textContent = `${length}/500`;

            // Update counter color based on length
            if (length > 450) {
                charCounter.className = 'char-counter danger';
            } else if (length > 400) {
                charCounter.className = 'char-counter warning';
            } else {
                charCounter.className = 'char-counter';
            }
        });

        // Initialize counter
        charCounter.textContent = `${commentInput.value.length}/500`;
    }

    const commentsList = document.querySelector(".custom-comments-list");
    const form = document.querySelector(".comment-form");

    // AJAX comment submit
    if (form) {
        form.addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData(form);

            fetch(window.location.pathname, {
                method: "POST",
                body: formData,
                headers: {"X-Requested-With": "XMLHttpRequest"}
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.html) {
                    commentsList.insertAdjacentHTML("afterbegin", data.html);
                    attachCommentActions();
                    form.reset();

                    // Reset character counter
                    if (charCounter) {
                        charCounter.textContent = '0/500';
                        charCounter.className = 'char-counter';
                    }

                    // Update comment count
                    const badge = document.querySelector('.comment-count-badge');
                    const currentCount = parseInt(badge.textContent);
                    badge.textContent = currentCount + 1;
                } else if (data.message) {
                    alert(data.message);
                }
            })
            .catch(err => console.error("Comment submission error:", err));
        });
    }

    // Bind likes and dropdowns
    function attachCommentActions() {
        document.querySelectorAll(".custom-like-form").forEach(form => {
            form.addEventListener("submit", function(e) {
                e.preventDefault();

                const commentId = this.dataset.commentId;
                const btn = this.querySelector(".custom-like-btn");
                const count = this.querySelector(".custom-like-count");

                // Prevent multiple simultaneous requests
                if (btn.classList.contains('loading')) return;

                // Add loading state
                btn.classList.add('loading');

                // Create proper form data
                const formData = new FormData(this);

                fetch(this.action, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                    body: new URLSearchParams(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Update UI based on response
                    if (data.likes_count !== undefined) {
                        count.textContent = data.likes_count;
                        if (data.liked) {
                            btn.classList.add('liked');
                            btn.style.color = 'red';
                        } else {
                            btn.classList.remove('liked');
                            btn.style.color = '#adb5bd';
                        }
                    }
                })
                .catch(error => {
                    console.error('Like error:', error);
                    // Fallback: submit form normally if AJAX fails
                    this.submit();
                })
                .finally(() => {
                    // Remove loading state
                    btn.classList.remove('loading');
                });
            });
        });
    }

    // Initial attachment of event listeners
    attachCommentActions();
});
</script>

</body>
</html>